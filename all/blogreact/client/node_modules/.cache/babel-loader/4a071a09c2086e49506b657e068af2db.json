{"ast":null,"code":"var is = require('type-is');\n\nvar Busboy = require('busboy');\n\nvar extend = require('xtend');\n\nvar appendField = require('append-field');\n\nvar Counter = require('./counter');\n\nvar MulterError = require('./multer-error');\n\nvar FileAppender = require('./file-appender');\n\nvar removeUploadedFiles = require('./remove-uploaded-files');\n\nfunction makeMiddleware(setup) {\n  return function multerMiddleware(req, res, next) {\n    if (!is(req, ['multipart'])) return next();\n    var options = setup();\n    var limits = options.limits;\n    var storage = options.storage;\n    var fileFilter = options.fileFilter;\n    var fileStrategy = options.fileStrategy;\n    var preservePath = options.preservePath;\n    req.body = Object.create(null);\n    var busboy;\n\n    try {\n      busboy = Busboy({\n        headers: req.headers,\n        limits: limits,\n        preservePath: preservePath\n      });\n    } catch (err) {\n      return next(err);\n    }\n\n    var appender = new FileAppender(fileStrategy, req);\n    var isDone = false;\n    var readFinished = false;\n    var errorOccured = false;\n    var pendingWrites = new Counter();\n    var uploadedFiles = [];\n\n    function done(err) {\n      if (isDone) return;\n      isDone = true;\n      req.unpipe(busboy);\n      busboy.removeAllListeners();\n      next(err);\n    }\n\n    function indicateDone() {\n      if (readFinished && pendingWrites.isZero() && !errorOccured) done();\n    }\n\n    function abortWithError(uploadError) {\n      if (errorOccured) return;\n      errorOccured = true;\n      pendingWrites.onceZero(function () {\n        function remove(file, cb) {\n          storage._removeFile(req, file, cb);\n        }\n\n        removeUploadedFiles(uploadedFiles, remove, function (err, storageErrors) {\n          if (err) return done(err);\n          uploadError.storageErrors = storageErrors;\n          done(uploadError);\n        });\n      });\n    }\n\n    function abortWithCode(code, optionalField) {\n      abortWithError(new MulterError(code, optionalField));\n    } // handle text field data\n\n\n    busboy.on('field', function (fieldname, value, _ref) {\n      let {\n        nameTruncated,\n        valueTruncated\n      } = _ref;\n      if (fieldname == null) return abortWithCode('MISSING_FIELD_NAME');\n      if (nameTruncated) return abortWithCode('LIMIT_FIELD_KEY');\n      if (valueTruncated) return abortWithCode('LIMIT_FIELD_VALUE', fieldname); // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY');\n      }\n\n      appendField(req.body, fieldname, value);\n    }); // handle files\n\n    busboy.on('file', function (fieldname, fileStream, _ref2) {\n      let {\n        filename,\n        encoding,\n        mimeType\n      } = _ref2;\n      // don't attach to the files object, if there is no file\n      if (!filename) return fileStream.resume(); // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY');\n      }\n\n      var file = {\n        fieldname: fieldname,\n        originalname: filename,\n        encoding: encoding,\n        mimetype: mimeType\n      };\n      var placeholder = appender.insertPlaceholder(file);\n      fileFilter(req, file, function (err, includeFile) {\n        if (err) {\n          appender.removePlaceholder(placeholder);\n          return abortWithError(err);\n        }\n\n        if (!includeFile) {\n          appender.removePlaceholder(placeholder);\n          return fileStream.resume();\n        }\n\n        var aborting = false;\n        pendingWrites.increment();\n        Object.defineProperty(file, 'stream', {\n          configurable: true,\n          enumerable: false,\n          value: fileStream\n        });\n        fileStream.on('error', function (err) {\n          pendingWrites.decrement();\n          abortWithError(err);\n        });\n        fileStream.on('limit', function () {\n          aborting = true;\n          abortWithCode('LIMIT_FILE_SIZE', fieldname);\n        });\n\n        storage._handleFile(req, file, function (err, info) {\n          if (aborting) {\n            appender.removePlaceholder(placeholder);\n            uploadedFiles.push(extend(file, info));\n            return pendingWrites.decrement();\n          }\n\n          if (err) {\n            appender.removePlaceholder(placeholder);\n            pendingWrites.decrement();\n            return abortWithError(err);\n          }\n\n          var fileInfo = extend(file, info);\n          appender.replacePlaceholder(placeholder, fileInfo);\n          uploadedFiles.push(fileInfo);\n          pendingWrites.decrement();\n          indicateDone();\n        });\n      });\n    });\n    busboy.on('error', function (err) {\n      abortWithError(err);\n    });\n    busboy.on('partsLimit', function () {\n      abortWithCode('LIMIT_PART_COUNT');\n    });\n    busboy.on('filesLimit', function () {\n      abortWithCode('LIMIT_FILE_COUNT');\n    });\n    busboy.on('fieldsLimit', function () {\n      abortWithCode('LIMIT_FIELD_COUNT');\n    });\n    busboy.on('close', function () {\n      readFinished = true;\n      indicateDone();\n    });\n    req.pipe(busboy);\n  };\n}\n\nmodule.exports = makeMiddleware;","map":{"version":3,"names":["is","require","Busboy","extend","appendField","Counter","MulterError","FileAppender","removeUploadedFiles","makeMiddleware","setup","multerMiddleware","req","res","next","options","limits","storage","fileFilter","fileStrategy","preservePath","body","Object","create","busboy","headers","err","appender","isDone","readFinished","errorOccured","pendingWrites","uploadedFiles","done","unpipe","removeAllListeners","indicateDone","isZero","abortWithError","uploadError","onceZero","remove","file","cb","_removeFile","storageErrors","abortWithCode","code","optionalField","on","fieldname","value","nameTruncated","valueTruncated","prototype","hasOwnProperty","call","length","fieldNameSize","fileStream","filename","encoding","mimeType","resume","originalname","mimetype","placeholder","insertPlaceholder","includeFile","removePlaceholder","aborting","increment","defineProperty","configurable","enumerable","decrement","_handleFile","info","push","fileInfo","replacePlaceholder","pipe","module","exports"],"sources":["/Users/khaliddahir/node_modules/multer/lib/make-middleware.js"],"sourcesContent":["var is = require('type-is')\nvar Busboy = require('busboy')\nvar extend = require('xtend')\nvar appendField = require('append-field')\n\nvar Counter = require('./counter')\nvar MulterError = require('./multer-error')\nvar FileAppender = require('./file-appender')\nvar removeUploadedFiles = require('./remove-uploaded-files')\n\nfunction makeMiddleware (setup) {\n  return function multerMiddleware (req, res, next) {\n    if (!is(req, ['multipart'])) return next()\n\n    var options = setup()\n\n    var limits = options.limits\n    var storage = options.storage\n    var fileFilter = options.fileFilter\n    var fileStrategy = options.fileStrategy\n    var preservePath = options.preservePath\n\n    req.body = Object.create(null)\n\n    var busboy\n\n    try {\n      busboy = Busboy({ headers: req.headers, limits: limits, preservePath: preservePath })\n    } catch (err) {\n      return next(err)\n    }\n\n    var appender = new FileAppender(fileStrategy, req)\n    var isDone = false\n    var readFinished = false\n    var errorOccured = false\n    var pendingWrites = new Counter()\n    var uploadedFiles = []\n\n    function done (err) {\n      if (isDone) return\n      isDone = true\n      req.unpipe(busboy)\n      busboy.removeAllListeners()\n      next(err)\n    }\n\n    function indicateDone () {\n      if (readFinished && pendingWrites.isZero() && !errorOccured) done()\n    }\n\n    function abortWithError (uploadError) {\n      if (errorOccured) return\n      errorOccured = true\n\n      pendingWrites.onceZero(function () {\n        function remove (file, cb) {\n          storage._removeFile(req, file, cb)\n        }\n\n        removeUploadedFiles(uploadedFiles, remove, function (err, storageErrors) {\n          if (err) return done(err)\n\n          uploadError.storageErrors = storageErrors\n          done(uploadError)\n        })\n      })\n    }\n\n    function abortWithCode (code, optionalField) {\n      abortWithError(new MulterError(code, optionalField))\n    }\n\n    // handle text field data\n    busboy.on('field', function (fieldname, value, { nameTruncated, valueTruncated }) {\n      if (fieldname == null) return abortWithCode('MISSING_FIELD_NAME')\n      if (nameTruncated) return abortWithCode('LIMIT_FIELD_KEY')\n      if (valueTruncated) return abortWithCode('LIMIT_FIELD_VALUE', fieldname)\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY')\n      }\n\n      appendField(req.body, fieldname, value)\n    })\n\n    // handle files\n    busboy.on('file', function (fieldname, fileStream, { filename, encoding, mimeType }) {\n      // don't attach to the files object, if there is no file\n      if (!filename) return fileStream.resume()\n\n      // Work around bug in Busboy (https://github.com/mscdex/busboy/issues/6)\n      if (limits && Object.prototype.hasOwnProperty.call(limits, 'fieldNameSize')) {\n        if (fieldname.length > limits.fieldNameSize) return abortWithCode('LIMIT_FIELD_KEY')\n      }\n\n      var file = {\n        fieldname: fieldname,\n        originalname: filename,\n        encoding: encoding,\n        mimetype: mimeType\n      }\n\n      var placeholder = appender.insertPlaceholder(file)\n\n      fileFilter(req, file, function (err, includeFile) {\n        if (err) {\n          appender.removePlaceholder(placeholder)\n          return abortWithError(err)\n        }\n\n        if (!includeFile) {\n          appender.removePlaceholder(placeholder)\n          return fileStream.resume()\n        }\n\n        var aborting = false\n        pendingWrites.increment()\n\n        Object.defineProperty(file, 'stream', {\n          configurable: true,\n          enumerable: false,\n          value: fileStream\n        })\n\n        fileStream.on('error', function (err) {\n          pendingWrites.decrement()\n          abortWithError(err)\n        })\n\n        fileStream.on('limit', function () {\n          aborting = true\n          abortWithCode('LIMIT_FILE_SIZE', fieldname)\n        })\n\n        storage._handleFile(req, file, function (err, info) {\n          if (aborting) {\n            appender.removePlaceholder(placeholder)\n            uploadedFiles.push(extend(file, info))\n            return pendingWrites.decrement()\n          }\n\n          if (err) {\n            appender.removePlaceholder(placeholder)\n            pendingWrites.decrement()\n            return abortWithError(err)\n          }\n\n          var fileInfo = extend(file, info)\n\n          appender.replacePlaceholder(placeholder, fileInfo)\n          uploadedFiles.push(fileInfo)\n          pendingWrites.decrement()\n          indicateDone()\n        })\n      })\n    })\n\n    busboy.on('error', function (err) { abortWithError(err) })\n    busboy.on('partsLimit', function () { abortWithCode('LIMIT_PART_COUNT') })\n    busboy.on('filesLimit', function () { abortWithCode('LIMIT_FILE_COUNT') })\n    busboy.on('fieldsLimit', function () { abortWithCode('LIMIT_FIELD_COUNT') })\n    busboy.on('close', function () {\n      readFinished = true\n      indicateDone()\n    })\n\n    req.pipe(busboy)\n  }\n}\n\nmodule.exports = makeMiddleware\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}